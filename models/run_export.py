import os
from subprocess import Popen, PIPE
import re
import tempfile

local_dir = os.path.dirname(os.path.realpath(__file__))
blender_dir = os.path.expandvars("%programfiles%/Blender Foundation/Blender")

def call(args):
    proc = Popen(args, stdout=PIPE, stderr=PIPE)
    out, err = proc.communicate()
    exitcode = proc.returncode
    #
    return exitcode, out, err

file_list = ['205gti','205gti_bbox']
s = "{:02x}".format(len(file_list))
for blend_file in file_list:
    print("Exporting: {}.blend".format(blend_file))
    fd, path = tempfile.mkstemp()
    try:
        os.close(fd)
        exitcode, out, err = call([os.path.join(blender_dir,"blender.exe"),os.path.join(local_dir,blend_file + ".blend"),"--background","--python",os.path.join(local_dir,"blender_export_uv.py"),"--","--out",path])
        if err:
            raise Exception('Unable to loadt: {}. Exception: {}'.format(blend_file,err))
        print("exit: {} \n out:{}\n err: {}\n".format(exitcode,out,err))
        with open(path, 'r') as outfile:
            s = s + outfile.read()
    finally:
        os.remove(path)

# extra data
# track + actors
s = s + "ff00ff00ff00ff00ff00ff00ff00ff00ff00ea00088a0948f300088c0948a100088a0948be00088709118a125109489f00088c0948bc00088709118c1282099e000809118a1251890948aa0008890911931282099e0082098c1251890948a8000889091194125109489d0082099512518709489a000887091191120a86094a85125109489b0008091196125187094898000887091191120a88094a851282099a0008091185120a86094a91125189094886000889091191120a870901860041094a841282099a00820985120a88094a91125189094884000889091191120a87090188008209841282099a00820984120a090186004187094a9112518a091191120a8709018f00820984128209990008091183120a820988004187094a91125188091191120a870901900041094a83128209980008091183120a83098f004189094a9a120a890901980041094a821282099700088209841283090190004189094a98120a8909019a00820982128209960008830984128209019a004187094a8a120a870901a300820982128209960083091183120a09019c004187094a88120a870901a400820982128209960082091183120a0901a400418a0901ab00820982128209950008091184128209a60041880901ac00820982128209940008091185128209dc008209821282099400820985120a0901db00080911821282099400820984120a0901db00080911831282099400820984128209db00080911841282099400820984128209da00080911851282099400820984128209d90008820985120a82099400820984128209d80008830984120a8309940082094a8312510948d7008309118412830901940083094a8312510948d600820911851282090195004183098412510948d40008091185120a090197004182098512510948d20008091185120a0901990041094a85128209d200820985120a09019b0041094a84128209d200820984120a09019d0082098412510948d1008209841282099e0082098512510948d0008209841282099e0041094a8512820948cf008209841282099f0041094a8412830948ce00820984128209a00041094a831251830948cc0008091183120a0901a10041094a831251850948c80008091183120a0901a3008209841251850948c700820984128209a4008209891251870948c000820984128209a40041094a891251870948bf00820984128209a50041094a8f1251870948b800820984128209a60041094a8f1251870948b700820984128209a7004187094a8f1251830948b400820984128209a8004187094a8f1251830948b300820984128209af004187094a891251830948b200820984128209b0004187094a891251830948b10082098412820948b6004185094a8712510948b00082098412830948b6004185094a8712510948af0041094a8312518309bb004183094a851251830948ad0041094a8312518209bc004183094a851251830948ad00820984128209bd004183094a851251830948ac00820984128209be004183094a851251830948ab0082094a8312510948c00041094a8712510948aa0083094a8312510948bf0008820988128209aa0041830984128209bc0008850988128209ab0041820984128209bb000885091188128209ac0082098412510948b500088509118d128209ac0082098512510948b300088509118d120a0901ac0041094a8512510948ad00088509118d120a850901ae0041094a8512510948ab00088509118d120a850901b00041094a8512820948a500088509118d120a850901b60041094a8412830948a300088509118d120a850901b80082094a8312518309a2000809118d120a850901bd0083094a8312518209a1000809118d120a850901be0041830984125109489d000883091189120a850901c40041820985125109489b000883091189120a850901c60041094a851282099a000883091185120a850901cc0041094a8412820999000883091185120a850901ce0082098412820998000883091185120a0901d30082098412820997000883091185120a0901d400820984128209960008091185120a830901ab00089c09488c00820984128209950008091185120a830901ab00089e09488b00820984128209940008091185120a830901ab000809119c125109488a008209841282099400820985120a830901ac0082099e1251094889008209841282099400820984120a830901ad00820984120a88094a91125109488800820984128209940082098412830901ae00820984128a094a911282098800820984128209940082098412820901af00820984128209018600418d094a8412820988008209841282099400820984128209b0008209841282098800418d098412820988008209841282099400820984128209b00082098412820993004182098412820988008209841282099400820984128209b000820984128209940082098412820988008209841282099400820984128209b000820984128209940082098412820988008209841282099400820984128209b000820984128209940082098412820988008209841282099400820984128209b00082098412820994008209841282098800820984128209940041094a8312510948af0082098412820994008209841282098800820984128209950041094a8312510948ae00820984128209940082098412820988008209841282099600820984128209ad0008091183120a0901940082098412820988008209841282099600820984128209ac0008091183120a0901950082098412820988008209841282099600820984128209ac00820984128209960082098412820988008209841282099600820984128209ac0082098412820996008209841282098800820984128209960082098412820948ab00820984128209960041094a83125109488700820984128209960082098412830948aa00820984128209970041094a8312510948860082098412820996008209841251830948a9008209841282099800820984128209860082098412820996008209871251830948a60082098412820998008209841282098600820984128209960041094a871251830948a50082098412820998008209841282098600820984128209970041094a891251830948a20082098412820998008209841282098600820984128209980041094a891251830948a1008209841282099800820984128209860082098412820999004183094a8912518309489e00820984128209980082098412820986008209841282099a004183094a8912518309489c0008091183120a0901980082098412820986008209841282099d004183094a891251830948980008091183120a0901990082098412820986008209841282099e004183094a8912518309489600088209841282099a008209841282098600820984128209a1004183094a8912519a09841282099a008209841282098600820984128209a2004183094a891251980911841282099a0082098412820948840008820984128209a5004183094aa41282099a00820984128a0984128209a6004183094aa31282099a00820984125188091184128209a9004183094aa01282099a00820992128209aa004183094a9e120a09019a0041094a90120a0901ad0041a009019c0041920901af00419e09019e0041900901ff00ff00ff00ff00ff00ff00ff00ff00ff00ff00ff009800004782774002228300255534877773208200378677750004666485000182777588774182003655676667837773002220850003827775578777748200121123824466827774880003827773123584777555774084000211345777778800016777728200847731113773860013467777890057777400015782775401112674108500024677778800025777520002655576213446827710850003467777880082015730000231136785776085000357777710890003308300135785777585000282777620890001108300138777208500827777208900018400138777508500177777408e0003678577764285000477776186000251860021378577764286004777728600067753348400100247827776777641860036776286000682777686001284776620860036775186000582777586000283777431870036742087008277708500111583774187000357418800055586004335776555300444830044400477769000010024101100827770200782771577778c000333870004827776644782774577778c00677760860004827775326782774577768b00038277738600048277741483774577748b000382777387008277702683770177748a00026782777382000222323102827762268277600157708a000267827772000183667202827762267776200157728a0002678377200283777102827762046664820057718b004783777602847700827740002220820057308b00028477615783777047742284000155108c00278377766784772777664183000155108c00048977278277638200011375118d0027887764827762000245577735208c00028877728277628200678277738d00068877706766408200278277718c0002678277555784777226328300478277518c00678277731103847772028400278277508b0006827755318200478377628500268277508b00277773118300048377408500046677518b0027777184000267827787002247518b0027777584000283772087002753108a002782772084006777762087002777548a008377408400278277208700677776890004837760840027827720860002677770890067837740840026777620860002677774850044624485772084002677758200228400026777748400078777768500047731100026510112640067827700013731578777708500025310820026775557762027827775557775877776870010830004668277764246857773578677208c00224682777667857751078577708a00108300046683778577510044624477749000224682778577519700268277857770970004827785775098004777847773990004778477509a00278477519a00048477519a00278477739a004785773099004785775199002785777311109700048677555285001232109000468677628400025777631088003341113431820024837774677640820001111483776410244311830006827757827763101709071d0b3506370a370f3413321a3521392638393239302a29292329203814390833062a0c251b20141b09180410720a05010a0901300602320502350502370602380802380f02380b023711023a38023a3a02393b02363b02303702313902323b02242802222802212902212a022e2802302802312a02312c021e3b02213b02233802223902181c021b1e021c1f021d21021c22021a23021421020706030b05030b0b030f0b030f0603240803260803280803270b03270c032a0c032a0b032b0a032b07030a37030531030b3403103a030633030d3803082e031036030931030f39030c04040d06040e07040c0a040e0c04070704050804070904090b040a0c04080c04040b04050b041808041809041f0d041b0d04190c043524043b2604332304392204372004392404062604141e04161f04252c041e36041d37040c2804112704152004132504112104262c040634040a14030814030616030517030619030919030a19030a1a03071b030a1c030c19030e16030c15030d1b030b16030a1103031403"

# pico-8 map format
# first 4096 bytes -> gfx (shared w/ map)
# second 4096 bytes -> map
if len(s)>=2*8192:
    raise Exception('Data string too long ({})'.format(len(s)))

tmp=s[:8192]
print("__gfx__")
# swap bytes
gfx_data = ""
for i in range(0,len(tmp),2):
    gfx_data = gfx_data + tmp[i+1:i+2] + tmp[i:i+1]
print(re.sub("(.{128})", "\\1\n", gfx_data, 0, re.DOTALL))

map_data=s[8192:]
if len(map_data)>0:
    print("__map__")
    print(re.sub("(.{256})", "\\1\n", map_data, 0, re.DOTALL))

